{% extends 'base.html' %}
{% block title %}Edit Recipe{% endblock %}
{% load static %}
{% block content %}
{% if messages %}
<div class="mb-6 space-y-2 ">
  {% for message in messages %}
    <div class="p-3 {% if message.tags == 'error' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %}">
      {{ message }}
    </div>
  {% endfor %}
</div>
{% endif %}

<div class="w-full h-full p-4 bg-cover bg-center" 
     style="background-image: url(&quot;{% static 'HomePage/images/veg-cutter.jpg' %}&quot;);">

  <h1 class="text-3xl font-bold bg-white text-center px-3 py-2 rounded-full"> Edit <span class="text-orange-400">Recipe</span></h1>

  <form method="post" enctype="multipart/form-data" class="mt-4 grid grid-rows-[repeat(2,1fr)] grid-cols-4 gap-4 p-2" action="{% url 'recipe:edit_recipe' recipe.pk %}">
    {% csrf_token %}

    <div class="font-open row-span-2 col-span-2">{% include "recipe/forms/recipe_form.html" with recipeform=recipeform %}</div>

    <div class="bg-amber-700 p-4 rounded-lg ">
      {% include "recipe/forms/nutrition_form.html" with nutritionform=nutritionform %}
    </div>

    <div class="flex flex-col space-y-4">
      <span class="text-3xl font-roboto text-blue-600 rounded-full bg-white self-start px-3 py-1">Add Image</span>
      {% include "recipe/forms/_image_form.html" with recipe_image=recipe_image %}
    </div>

    <div class="border-t rounded-xl border-gray-300 pt-6 h-full w-full col-span-2 bg-white p-3">
      <h1 class="text-xl font-semibold text-gray-700 mb-3">Ingredients</h1>
      <div class="relative">
        <div id="ingredient-list" class="max-h-80 overflow-y-auto pr-4 pb-20">
          {{ ingredient_formset.management_form }}
          {% for form in ingredient_formset %}
            {% include 'recipe/forms/_ingredient_form.html' with form=form %}
          {% endfor %}
        </div>
        <div class="absolute left-4 bottom-4 z-10">
          <button type="button"
                  hx-get="{% url 'recipe:add_ingredient_form' %}"
                  hx-target="#ingredient-list"
                  hx-swap="beforeend"
                  hx-include="input[name='form-TOTAL_FORMS']"
                  class="px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 transition shadow-lg">
            ➕ Add Ingredient
          </button>
        </div>
      </div>
    </div>

    <div class="text-center col-span-4">
      <button type="submit" class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-orange-600 transition">
        Update Recipe
      </button>
    </div>

  </form>
</div>

<script>
// Keep indices contiguous and update TOTAL_FORMS; prevent removing the last form
(function(){
  function reindexForms() {
    const container = document.getElementById('ingredient-list');
    if (!container) return;
    const forms = Array.from(container.querySelectorAll('.ingredient-form'));
    forms.forEach((formDiv, index) => {
      formDiv.dataset.index = index;
      formDiv.querySelectorAll('input, select, textarea').forEach(el => {
        if (!el.name) return;
        el.name = el.name.replace(/form-\d+-/, 'form-' + index + '-');
        if (el.id) el.id = el.id.replace(/form-\d+-/, 'form-' + index + '-');
      });
      formDiv.querySelectorAll('label').forEach(lbl => {
        if (lbl.htmlFor) lbl.htmlFor = lbl.htmlFor.replace(/form-\d+-/, 'form-' + index + '-');
      });
    });

    // Update TOTAL_FORMS
    const total = forms.length;
    const totalInput = document.querySelector('input[name="form-TOTAL_FORMS"]');
    if (totalInput) totalInput.value = total;
    const totalById = document.getElementById('id_form-TOTAL_FORMS');
    if (totalById) totalById.value = total;
  }

  document.addEventListener('click', function(e){
    if (e.target && e.target.matches('.remove-ingredient')) {
      e.preventDefault();
      const item = e.target.closest('.ingredient-form');
      if (!item) return;

      // find the hidden id input for this form (if any)
      const idInput = item.querySelector('input[name$="-id"]');
      const deleteInput = item.querySelector('input[name$="-DELETE"]');

      // If this is an existing instance (has id value), toggle its DELETE flag and visually mark it
      if (idInput && idInput.value) {
        // toggle delete
        const willDelete = !(deleteInput && deleteInput.checked);
        if (deleteInput) deleteInput.checked = willDelete;

        if (willDelete) {
          item.classList.add('opacity-50');
          item.style.textDecoration = 'line-through';
          e.target.textContent = '↺'; // change to undo icon
        } else {
          item.classList.remove('opacity-50');
          item.style.textDecoration = 'none';
          e.target.textContent = '✖';
        }

        // keep the form in the DOM so management form indices stay stable
        return;
      }

      const container = document.getElementById('ingredient-list');
      const forms = container.querySelectorAll('.ingredient-form');
      // if removing last form, just clear it
      if (forms.length <= 1) {
        const inputs = forms[0].querySelectorAll('input, textarea, select');
        inputs.forEach(i => {
          if (i.type === 'checkbox' || i.type === 'radio') i.checked = false;
          else i.value = '';
        });
        reindexForms();
        return;
      }

      item.remove();
      reindexForms();
    }
  });

  // After HTMX adds a fragment, ensure names/ids and TOTAL_FORMS are consistent
  document.body.addEventListener('htmx:afterSwap', function(evt){
    if (evt.detail && evt.detail.target) {
      const target = evt.detail.target;
      if (target.id === 'ingredient-list' || (target.closest && target.closest('#ingredient-list'))) {
        reindexForms();
      }
    }
  });

  // ensure correct indexing on initial load
  document.addEventListener('DOMContentLoaded', reindexForms);
})();
</script>
{% endblock %}
