{% extends 'base.html' %}
{% block title %}Add Recipe{% endblock %}
{% load static %}
{% block content %}
<!-- Display Django messages -->
{% if messages %}
  <div class="mb-6 space-y-2">
    {% for message in messages %}
      <div
        class="p-3
          {% if message.tags == 'error' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}

<div class="w-full h-full p-4 bg-cover bg-center" 
     style="background-image: url(&quot;{% static 'HomePage/images/veg-cutter.jpg' %}&quot;);">

  <h1 class="text-3xl font-bold bg-white text-center px-3 py-2 rounded-full">
    Create a <span class="text-orange-400">New</span> Recipe
  </h1>

  <form method="post" enctype="multipart/form-data"
        class="mt-4 grid grid-rows-[repeat(2,1fr)] grid-cols-4 gap-4 p-2">
    {% csrf_token %}

    <!-- Recipe form -->
    <div class="font-open row-span-2 col-span-2">
      {% include "recipe_management/forms/recipe_form.html" with recipeform=recipeform %}
    </div>

    <!-- Nutrition form -->
    <div class="bg-amber-700 p-4 rounded-lg">
      {% include "recipe_management/forms/nutrition_form.html" with nutritionform=nutritionform %}
    </div>

    <!-- Image form -->
    <div class="flex flex-col space-y-4">
      <span class="text-3xl font-roboto text-blue-600 rounded-full bg-white self-start px-3 py-1">Add Image</span>
      {% include "recipe_management/forms/_image_form.html" with recipe_image=recipe_image %}
    </div>

    <!-- Ingredients -->
    <div class="border-t rounded-xl border-gray-300 pt-6 h-full w-full col-span-2 bg-white p-3">
      <h1 class="text-xl font-semibold text-gray-700 mb-3">Ingredients</h1>

      <div class="relative">
        <!-- Constrain list height and allow scrolling on overflow -->
        <div id="ingredient-list" class="max-h-[60vh] overflow-y-auto pr-4 pb-20 transition-all duration-300 ease-in-out">
          {{ ingredient_formset.management_form }}
          {% for form in ingredient_formset %}
            {% include 'recipe_management/forms/_ingredient_form.html' with form=form %}
          {% endfor %}
        </div>

        <!-- Add button pinned bottom-left of the panel -->
        <div class="absolute left-4 bottom-4 z-10">
          <button type="button"
                  hx-get="{% url 'recipe_management:add_ingredient_form' %}"
                  hx-target="#ingredient-list"
                  hx-swap="beforeend"
                  hx-include="input[name='form-TOTAL_FORMS']"
                  class="px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 transition shadow-lg">
            ➕ Add Ingredient
          </button>
        </div>
      </div>
    </div>

    <!-- Submit -->
    <div class="text-center">
      <button type="submit"
              class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-orange-600 transition">
        Save Recipe
      </button>
    </div>
  </form>
</div>

<script>
// Dynamically handle ingredient form list behavior
(function(){
  function reindexForms() {
    const container = document.getElementById('ingredient-list');
    if (!container) return;
    const forms = Array.from(container.querySelectorAll('.ingredient-form'));
    forms.forEach((formDiv, index) => {
      formDiv.dataset.index = index;
      formDiv.querySelectorAll('input, select, textarea').forEach(el => {
        if (!el.name) return;
        el.name = el.name.replace(/form-\d+-/, 'form-' + index + '-');
        if (el.id) el.id = el.id.replace(/form-\d+-/, 'form-' + index + '-');
      });
      formDiv.querySelectorAll('label').forEach(lbl => {
        if (lbl.htmlFor)
          lbl.htmlFor = lbl.htmlFor.replace(/form-\d+-/, 'form-' + index + '-');
      });
    });

    const total = forms.length;
    const totalInput = document.querySelector('input[name="form-TOTAL_FORMS"]');
    if (totalInput) totalInput.value = total;
    const totalById = document.getElementById('id_form-TOTAL_FORMS');
    if (totalById) totalById.value = total;
  }

  document.addEventListener('click', function(e){
    if (e.target && e.target.matches('.remove-ingredient')) {
      e.preventDefault();
      const container = document.getElementById('ingredient-list');
      const forms = container.querySelectorAll('.ingredient-form');

      // If there’s only one form, hide it and add a new one
      if (forms.length <= 1) {
        const lastForm = forms[0];
        lastForm.style.display = 'none'; // hide instead of clearing data

        const addBtn = document.querySelector('button[hx-get*="add_ingredient_form"]');
        if (addBtn) addBtn.click();

        // Optional small alert (or toast)
        alert('Last ingredient hidden. A new blank ingredient has been added.');

        reindexForms();
        return;
      }

      const item = e.target.closest('.ingredient-form');
      if (!item) return;
      item.remove();
      reindexForms();
    }
  });

  // Reindex after HTMX swap (new form added dynamically)
  document.body.addEventListener('htmx:afterSwap', function(evt){
    if (evt.detail && evt.detail.target) {
      const target = evt.detail.target;
      if (target.id === 'ingredient-list' ||
          (target.closest && target.closest('#ingredient-list'))) {
        reindexForms();
      }
    }
  });

  // Initial setup
  document.addEventListener('DOMContentLoaded', reindexForms);
})();
</script>
{% endblock %}
